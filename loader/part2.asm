; -- multi-part loader example - demo part 2 --
;
; Platform: C64
; Code: Jesder / 0xc64
; Site: http://www.0xc64.com
; Notes: sid track used - Numero_1.sid - Alexander Rotzsch (Fanta)
;


                        ; kernal routines

KER_CLRSCREEN           .equ $e544              ; clear screen


                        ; common registers

REG_INTFLAG             .equ $d019              ; interrupt flag register
REG_BORCOLOUR           .equ $d020              ; border colour register
REG_BGCOLOUR            .equ $d021              ; background colour register
REG_KEYBOARD_PORT_A     .equ $dc00
REG_KEYBOARD_PORT_B     .equ $dc01


                        ; constants

C_SCREEN_RAM            .equ $0400
C_UNPACK_ROUTINE        .equ $0810
C_UNPACK_DEST           .equ $0824
C_UNPACK_SOURCE         .equ $0834
C_APPLY_INTERRUPT       .equ $0840
C_EXIT_PART             .equ $084c
C_MUSIC_LOCATION        .equ $1000
C_MUSIC_INIT            .equ $1000
C_MUSIC_PLAY            .equ $1003
C_UNPACK_LOCATION       .equ $4000
C_COLOUR_RAM            .equ $d800
C_PLACEHOLDER           .equ $ffff


                        ; program start

                        .org $0950


                        ; intro sync ------------------------------------------------------------------------------------------------------]
                        ; -----------------------------------------------------------------------------------------------------------------]

sync_intro              inc REG_INTFLAG                 ; acknowledge interrupt

                        jsr KER_CLRSCREEN               ; clear screen

                        lda #000                        ; initialise screen
                        sta REG_BORCOLOUR
                        sta REG_BGCOLOUR

                        lda #<music_data                 
                        ldx #>music_data
                        sta C_UNPACK_SOURCE + 1
                        stx C_UNPACK_SOURCE + 2
                        lda #<C_UNPACK_LOCATION
                        ldx #>C_UNPACK_LOCATION
                        sta C_UNPACK_DEST + 1
                        stx C_UNPACK_DEST + 2
                        jsr C_UNPACK_ROUTINE

                        ldy #010                        ; relocate music
relocate_music          ldx #000
relocate_music_block    lda C_UNPACK_LOCATION, x
                        sta C_MUSIC_LOCATION, x
                        inx
                        bne relocate_music_block
                        inc relocate_music_block + 2
                        inc relocate_music_block + 5
                        dey
                        bne relocate_music

                        ldx #039                        ; init messages
render_messages         lda message1, x
                        sta C_SCREEN_RAM + $28, x
                        lda message2, x
                        sta C_SCREEN_RAM + $78, x
                        lda #010
                        sta C_COLOUR_RAM + $28, x
                        sta C_COLOUR_RAM + $78, x
                        dex
                        bpl render_messages

                        ldx #000                        ; initialise music
                        ldy #000
                        lda #000
                        jsr C_MUSIC_INIT                        

                        lda #025                        ; register music player interrupt
                        ldx #<update_music
                        ldy #>update_music
                        jmp C_APPLY_INTERRUPT


                        ; update routine --------------------------------------------------------------------------------------------------]
                        ; -----------------------------------------------------------------------------------------------------------------]

update_music            inc REG_INTFLAG                 ; acknowledge interrupt

                        lda #001                        ; show raster time used by music update
                        sta REG_BORCOLOUR

                        jsr C_MUSIC_PLAY

                        lda #000
                        sta REG_BORCOLOUR

                        lda #$7f                        ; detect space bar
                        sta REG_KEYBOARD_PORT_A
                        lda REG_KEYBOARD_PORT_B
                        and #$10
                        bne update_music_done

                        jmp C_EXIT_PART

update_music_done       jmp $ea81



                        ; data tables -----------------------------------------------------------------------------------------------------]
                        ; -----------------------------------------------------------------------------------------------------------------]

message1                .byte 032, 032, 032, 032, 032, 019, 009, 013, 016, 012, 005, 032, 012, 015, 001, 004
                        .byte 005, 018, 032, 005, 024, 001, 013, 016, 012, 005, 032, 045, 032, 048, 024, 003
                        .byte 054, 052, 032, 032, 032, 032, 032, 032
message2                .byte 032, 032, 032, 032, 032, 032, 032, 032, 016, 018, 005, 019, 019, 032, 019, 016
                        .byte 001, 003, 005, 032, 020, 015, 032, 003, 015, 014, 020, 009, 014, 021, 005, 032
                        .byte 032, 032, 032, 032, 032, 032, 032, 032

music_data              .byte $4c, $48, $11, $4c, $21, $11, $78, $a9, $0a, $8d, $86, $02, $20, $44, $e5, $a9
                        .byte $00, $8d, $20, $d0, $8d, $21, $d0, $20, $48, $11, $a9, $01, $8d, $0d, $dc, $8d
                        .byte $1a, $d0, $a9, $33, $8d, $12, $d0, $a9, $1b, $8d, $11, $d0, $a2, $1f, $bd, $80
                        .byte $10, $9d, $04, $04, $bd, $a0, $10, $9d, $2c, $04, $bd, $c0, $10, $9d, $54, $04
                        .byte $bd, $e0, $10, $9d, $7c, $04, $bd, $00, $11, $9d, $a4, $04, $ca, $10, $df, $a9
                        .byte $62, $8d, $14, $03, $a9, $10, $8d, $15, $03, $a9, $17, $8d, $18, $d0, $58, $4c
                        .byte $5f, $10, $ee, $19, $d0, $a9, $0f, $8d, $20, $d0, $20, $21, $11, $a9, $00, $8d
                        .byte $20, $d0, $a9, $80, $8d, $91, $02, $4c, $31, $ea, $c2, $06, $00, $c2, $20, $2d
                        .byte $c2, $09, $20, $4d, $55, $53, $49, $43, $20, $42, $59, $20, $46, $41, $4e, $54
                        .byte $41, $c2, $0a, $20, $30, $31, $2e, $30, $36, $2e, $31, $39, $39, $33, $20, $c2
                        .byte $0e, $2e, $20, $4e, $4f, $2e, $31, $c2, $04, $20, $55, $53, $45, $20, $54, $48
                        .byte $49, $53, $20, $54, $55, $4e, $45, $20, $26, $20, $43, $52, $45, $44, $49, $54
                        .byte $20, $4d, $45, $21, $c2, $03, $20, $c2, $20, $2d, $00, $a2, $00, $ce, $90, $11
                        .byte $30, $0c, $20, $26, $13, $20, $25, $13, $4c, $25, $13, $ff, $fe, $ff, $a9, $02
                        .byte $8d, $90, $11, $20, $40, $11, $20, $3f, $11, $e8, $de, $8a, $11, $30, $4c, $4c
                        .byte $26, $13, $a9, $1f, $8d, $18, $d4, $a9, $f0, $8d, $17, $d4, $29, $0f, $8d, $62
                        .byte $13, $a2, $0f, $9d, $81, $11, $ca, $10, $fa, $a2, $02, $bd, $b9, $15, $85, $fa
                        .byte $bd, $bc, $15, $85, $fb, $a0, $00, $b1, $fa, $9d, $8d, $11, $c8, $b1, $fa, $9d
                        .byte $e6, $11, $29, $0f, $9d, $e9, $11, $ca, $10, $e1, $60, $19, $00, $00, $41, $00
                        .byte $10, $c2, $04, $00, $04, $04, $01, $00, $02, $00, $bc, $8d, $11, $c0, $fe, $d0
                        .byte $09, $bd, $84, $11, $29, $fe, $9d, $84, $11, $60, $b9, $c4, $18, $85, $fa, $b9
                        .byte $86, $18, $85, $fb, $bc, $81, $11, $b1, $fa, $30, $20, $c9, $60, $90, $43, $29
                        .byte $1f, $9d, $8a, $11, $a9, $fe, $9d, $31, $11, $20, $98, $11, $4c, $87, $12, $00
                        .byte $07, $0e, $1f, $60, $00, $7d, $13, $e8, $06, $1a, $06, $c9, $a0, $90, $16, $29
                        .byte $1f, $9d, $8a, $11, $b0, $e6, $01, $00, $00, $10, $07, $c2, $04, $00, $07, $07
                        .byte $0f, $07, $05, $07, $c2, $03, $0a, $9d, $d9, $14, $c8, $b1, $fa, $c9, $60, $b0
                        .byte $bd, $85, $fc, $c8, $bd, $e6, $11, $c2, $04, $4a, $18, $65, $fc, $9d, $c9, $11
                        .byte $84, $fc, $a8, $b9, $37, $15, $9d, $cc, $11, $9d, $e2, $14, $b9, $c5, $12, $9d
                        .byte $cf, $11, $9d, $b6, $13, $a4, $fc, $b1, $fa, $9d, $41, $12, $29, $1f, $9d, $8a
                        .byte $11, $b1, $fa, $30, $22, $29, $20, $f0, $45, $c8, $b1, $fa, $9d, $47, $12, $c8
                        .byte $b1, $fa, $9d, $4a, $12, $4c, $77, $12, $45, $43, $47, $09, $00, $18, $50, $cf
                        .byte $10, $ff, $aa, $00, $00, $05, $00, $8e, $62, $13, $c8, $b1, $fa, $8d, $66, $13
                        .byte $29, $0f, $0a, $38, $e9, $10, $8d, $a0, $13, $c8, $b1, $fa, $d0, $07, $a9, $f0
                        .byte $8d, $17, $d4, $d0, $09, $8d, $6b, $13, $bd, $b3, $13, $8d, $17, $d4, $a9, $ff
                        .byte $9d, $31, $11, $9d, $b9, $13, $a9, $00, $9d, $dd, $11, $9d, $bd, $13, $c8, $b1
                        .byte $fa, $c9, $ff, $d0, $32, $de, $e9, $11, $10, $2b, $bd, $b9, $15, $85, $fa, $bd
                        .byte $bc, $15, $85, $fb, $bc, $87, $11, $c8, $c8, $b1, $fa, $c9, $ff, $d0, $02, $a0
                        .byte $00, $98, $9d, $87, $11, $b1, $fa, $9d, $8d, $11, $c8, $b1, $fa, $9d, $e6, $11
                        .byte $29, $0f, $9d, $e9, $11, $a0, $00, $98, $9d, $81, $11, $60, $c2, $0b, $01, $c2
                        .byte $07, $02, $c2, $05, $03, $c2, $04, $04, $c2, $03, $05, $c2, $03, $06, $07, $07
                        .byte $08, $08, $09, $09, $0a, $0a, $0b, $0c, $0d, $0d, $0e, $0f, $10, $11, $12, $13
                        .byte $14, $15, $17, $18, $1a, $1b, $1d, $1f, $20, $22, $24, $27, $29, $2b, $2e, $31
                        .byte $34, $37, $3a, $3e, $41, $45, $49, $4e, $52, $57, $5c, $62, $68, $6e, $75, $7c
                        .byte $83, $8b, $93, $9c, $a5, $af, $b9, $c4, $d0, $dd, $ea, $f8, $fd, $e8, $bc, $d9
                        .byte $14, $84, $fc, $bd, $41, $12, $29, $40, $d0, $5e, $9d, $44, $12, $b9, $55, $16
                        .byte $85, $fa, $b9, $56, $16, $bc, $c6, $11, $99, $06, $d4, $a5, $fa, $99, $05, $d4
                        .byte $bd, $84, $11, $29, $fe, $99, $04, $d4, $a4, $fc, $b9, $57, $16, $9d, $84, $11
                        .byte $b9, $58, $16, $9d, $dc, $14, $9d, $df, $14, $e0, $00, $d0, $0a, $a9, $93, $8d
                        .byte $9e, $13, $a9, $0d, $8d, $96, $13, $a9, $00, $9d, $e0, $11, $9d, $e3, $11, $b9
                        .byte $5a, $16, $c2, $03, $4a, $9d, $4d, $12, $bd, $41, $12, $09, $40, $9d, $41, $12
                        .byte $b9, $5c, $16, $95, $fd, $4c, $85, $14, $ec, $62, $13, $d0, $12, $a9, $00, $f0
                        .byte $0e, $ce, $96, $13, $18, $a9, $11, $69, $f6, $8d, $9e, $13, $8d, $16, $d4, $b5
                        .byte $fd, $29, $0f, $f0, $1a, $20, $e5, $14, $4c, $22, $14, $f1, $f3, $f7, $06, $1a
                        .byte $01, $c2, $03, $ff, $00, $04, $c2, $06, $00, $01, $01, $00, $bd, $41, $12, $29
                        .byte $20, $d0, $54, $b5, $fd, $29, $10, $f0, $4e, $de, $4d, $12, $10, $49, $fe, $4d
                        .byte $12, $bd, $bd, $13, $29, $03, $a8, $b9, $c3, $13, $d0, $13, $a4, $fc, $38, $bd
                        .byte $cc, $11, $f9, $5b, $16, $9d, $cc, $11, $b0, $18, $de, $cf, $11, $d0, $13, $a4
                        .byte $fc, $18, $bd, $cc, $11, $79, $5b, $16, $9d, $cc, $11, $90, $05, $fe, $cf, $11
                        .byte $b0, $00, $fe, $dd, $11, $b9, $5a, $16, $29, $0f, $dd, $dd, $11, $d0, $08, $a9
                        .byte $00, $9d, $dd, $11, $fe, $bd, $13, $a4, $fc, $b9, $59, $16, $85, $fc, $b5, $fd
                        .byte $29, $40, $f0, $14, $18, $a5, $fc, $7d, $dc, $14, $9d, $dc, $14, $a5, $fc, $7d
                        .byte $df, $14, $9d, $df, $14, $4c, $85, $14, $b5, $fd, $29, $20, $f0, $3c, $bd, $e3
                        .byte $11, $f0, $10, $18, $bd, $dc, $14, $65, $fc, $9d, $dc, $14, $90, $13, $fe, $df
                        .byte $14, $b0, $0e, $38, $bd, $dc, $14, $e5, $fc, $9d, $dc, $14, $b0, $03, $de, $df
                        .byte $14, $fe, $e0, $11, $a5, $fc, $29, $0f, $dd, $e0, $11, $d0, $0d, $a9, $00, $9d
                        .byte $e0, $11, $bd, $e3, $11, $49, $01, $9d, $e3, $11, $bc, $c6, $11, $bd, $84, $11
                        .byte $99, $04, $d4, $bd, $df, $14, $99, $03, $d4, $bd, $dc, $14, $99, $02, $d4, $bd
                        .byte $41, $12, $29, $20, $f0, $2b, $bd, $47, $12, $29, $01, $f0, $0a, $bd, $b9, $13
                        .byte $49, $ff, $9d, $b9, $13, $d0, $1a, $18, $bd, $e2, $14, $7d, $47, $12, $9d, $e2
                        .byte $14, $99, $00, $d4, $bd, $b6, $13, $7d, $4a, $12, $9d, $b6, $13, $99, $01, $d4
                        .byte $60, $bd, $cc, $11, $99, $00, $d4, $bd, $cf, $11, $99, $01, $d4, $60, $08, $00
                        .byte $10, $aa, $5f, $08, $a6, $8d, $08, $85, $13, $16, $a8, $b9, $98, $15, $85, $fa
                        .byte $b9, $a8, $15, $85, $fb, $bc, $44, $12, $b1, $fa, $3d, $31, $11, $9d, $84, $11
                        .byte $c8, $b1, $fa, $30, $04, $18, $7d, $c9, $11, $29, $7f, $8d, $29, $15, $c8, $b1
                        .byte $fa, $f0, $03, $8d, $9e, $13, $c8, $b1, $fa, $c9, $fe, $90, $0c, $f0, $04, $a0
                        .byte $00, $f0, $06, $b5, $fd, $29, $f0, $95, $fd, $98, $9d, $44, $12, $a0, $20, $b9
                        .byte $37, $15, $9d, $cc, $11, $b9, $c5, $12, $9d, $cf, $11, $60, $16, $27, $38, $4b
                        .byte $5f, $73, $8a, $a1, $ba, $d4, $f0, $0e, $2d, $4e, $71, $96, $bd, $e7, $13, $42
                        .byte $74, $a9, $e0, $1b, $5a, $9b, $e2, $2c, $7b, $ce, $27, $85, $e8, $51, $c1, $37
                        .byte $b4, $37, $c4, $57, $f5, $9c, $4e, $09, $d0, $a3, $82, $6e, $68, $6e, $88, $af
                        .byte $eb, $39, $9c, $13, $a1, $46, $04, $dc, $d0, $dc, $10, $5e, $d6, $72, $38, $26
                        .byte $42, $8c, $08, $b8, $a0, $b8, $20, $bc, $ac, $e4, $70, $4c, $84, $18, $10, $70
                        .byte $40, $70, $40, $78, $58, $c8, $e0, $98, $08, $30, $20, $2e, $67, $69, $bf, $c9
                        .byte $e2, $f8, $02, $15, $28, $3b, $4e, $4f, $50, $51, $52, $53, $54, $e0, $c2, $04
                        .byte $15, $c2, $0b, $16, $22, $a5, $ac, $c7, $c2, $03, $16, $41, $0c, $00, $41, $00
                        .byte $00, $41, $00, $00, $fe, $81, $df, $00, $11, $ad, $00, $11, $aa, $00, $11, $a8
                        .byte $00, $11, $a6, $00, $11, $a4, $00, $11, $a2, $00, $10, $a0, $00, $fe, $81, $da
                        .byte $00, $41, $ad, $00, $40, $aa, $00, $80, $da, $00, $80, $df, $00, $40, $aa, $00
                        .byte $80, $da, $00, $fe, $81, $fe, $00, $11, $00, $00, $81, $fe, $00, $fe, $41, $00
                        .byte $00, $41, $00, $00, $41, $03, $00, $41, $03, $00, $41, $07, $00, $41, $07, $00
                        .byte $ff, $41, $00, $00, $41, $00, $00, $41, $04, $00, $41, $04, $00, $41, $09, $00
                        .byte $41, $09, $00, $ff, $41, $00, $00, $41, $00, $00, $41, $03, $00, $41, $03, $00
                        .byte $41, $08, $00, $41, $08, $00, $ff, $41, $00, $00, $41, $00, $00, $41, $04, $00
                        .byte $41, $04, $00, $41, $07, $00, $41, $07, $00, $c2, $08, $ff, $08, $90, $41, $8f
                        .byte $50, $62, $80, $b0, $0e, $ee, $19, $aa, $40, $22, $08, $b1, $0f, $a9, $09, $08
                        .byte $c2, $03, $00, $02, $0f, $a9, $09, $08, $c2, $03, $00, $03, $07, $03, $09, $09
                        .byte $c2, $03, $00, $04, $00, $7c, $09, $04, $10, $00, $00, $65, $00, $7c, $09, $04
                        .byte $10, $00, $00, $66, $00, $7c, $09, $04, $10, $00, $00, $67, $00, $7c, $09, $04
                        .byte $10, $00, $00, $68, $c2, $08, $ff, $01, $07, $01, $13, $01, $03, $ff, $00, $07
                        .byte $03, $00, $05, $00, $0d, $00, $07, $10, $0e, $10, $07, $10, $0f, $10, $0d, $00
                        .byte $07, $00, $0e, $00, $07, $00, $0f, $00, $ff, $02, $0f, $04, $06, $06, $00, $08
                        .byte $00, $09, $00, $0a, $00, $0b, $00, $08, $00, $09, $00, $0a, $00, $0b, $00, $08
                        .byte $00, $09, $00, $0a, $00, $0b, $00, $08, $00, $09, $00, $0a, $00, $0c, $00, $08
                        .byte $10, $09, $10, $0a, $10, $0b, $10, $08, $10, $09, $10, $0a, $10, $0b, $10, $08
                        .byte $10, $09, $10, $0a, $10, $0b, $10, $08, $10, $09, $10, $0a, $10, $0c, $10, $08
                        .byte $00, $09, $00, $0a, $00, $0b, $00, $08, $00, $09, $00, $0a, $00, $0b, $00, $08
                        .byte $00, $09, $00, $0a, $00, $0b, $00, $08, $00, $09, $00, $0a, $00, $0c, $00, $ff
                        .byte $7f, $ff, $81, $1a, $85, $93, $0d, $1a, $05, $1a, $03, $21, $05, $21, $05, $21
                        .byte $03, $1d, $05, $1d, $05, $1d, $03, $1f, $05, $1f, $05, $1f, $03, $ff, $82, $00
                        .byte $07, $ff, $80, $39, $1f, $ab, $35, $03, $37, $03, $39, $03, $37, $03, $35, $03
                        .byte $32, $01, $35, $01, $32, $01, $30, $01, $32, $13, $30, $03, $32, $0f, $35, $03
                        .byte $32, $01, $30, $01, $37, $03, $34, $01, $37, $01, $ff, $82, $00, $03, $84, $3c
                        .byte $03, $83, $00, $03, $84, $3c, $03, $ff, $80, $39, $1f, $ab, $37, $03, $39, $03
                        .byte $37, $03, $3c, $01, $39, $01, $37, $01, $3c, $01, $3e, $1f, $bf, $ff, $82, $00
                        .byte $03, $84, $3c, $03, $83, $00, $03, $00, $01, $00, $01, $ff, $80, $39, $01, $37
                        .byte $03, $39, $05, $37, $03, $35, $03, $32, $03, $35, $05, $35, $05, $37, $1b, $ff
                        .byte $82, $00, $03, $85, $32, $03, $83, $00, $03, $85, $32, $03, $ff, $82, $00, $03
                        .byte $86, $30, $03, $83, $00, $03, $86, $30, $03, $ff, $82, $00, $03, $87, $2f, $03
                        .byte $83, $00, $03, $87, $2f, $03, $ff, $82, $00, $03, $88, $30, $03, $83, $00, $03
                        .byte $88, $30, $03, $ff, $82, $00, $03, $88, $30, $03, $83, $00, $03, $88, $30, $01
                        .byte $83, $00, $01, $ff, $67, $ff, $80, $39, $01, $37, $03, $39, $05, $37, $03, $35
                        .byte $03, $3c, $03, $3e, $07, $39, $05, $37, $19, $ff, $80, $39, $01, $37, $03, $39
                        .byte $05, $37, $03, $35, $03, $3c, $03, $3e, $07, $39, $05, $37, $11, $c2, $5b, $ff
                        .byte $c2, $0d, $17, $c2, $30, $18, $01, $2e, $30, $4c, $50, $79, $86, $9c, $aa, $be
                        .byte $cb, $d8, $e5, $f2, $02, $04, $18, $2c, $2e, $30, $32, $34, $36, $38, $3a, $3c
                        .byte $3e, $40, $42, $44, $46, $48, $4a, $4c, $4e, $50, $52, $54, $56, $58, $5a, $5c
                        .byte $5e, $60, $62, $64, $66, $68, $6a, $6c, $6e, $70, $72, $74, $76, $78, $7a, $7c
                        .byte $7e, $80, $82, $84, $2d, $45, $4e, $44, $2d, $c2, $00